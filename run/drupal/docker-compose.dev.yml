version: '3.7'

# Dev stack
#
# - Drupal source code does not change with the environment.
# - Uses PHP FPM image with debugging tools enabled.
# - MUST use MOUNTED volumes instead of NAMED volumes in order to view and debug sources from host IDEs.
# - However with VSC it may be possible to avoid mounts https://code.visualstudio.com/docs/remote/containers-advanced

services:

  drupal:
    # The codebase is environment-agnostic and therefore hardcoded to prod.
    image: "alexanderallen/drupal-8.prod:alpine-3.11"
    volumes:
      - app:/app

  nginx:
    volumes:
      - app:/app

  php-fpm:
    # Allow nobody user logging to /dev/stdout.
    tty: true
    image: "alexanderallen/php7-fpm.${ENVIRONMENT:-dev}:alpine-3.11"
    environment:
      PHP_FPM_SLOWLOG_TIMEOUT: 3
      # Use environment variables to speed up FPM optimization cycles.
      PHP_FPM_PM_MANAGER: dynamic
      PHP_FPM_CHILDREN_MAX: 5
      # Default Value: min_spare_servers + (max_spare_servers - min_spare_servers) / 2
      PHP_FPM_CHILDREN_START: 2
      PHP_FPM_CHILDREN_SPARE_MIN: 1
      PHP_FPM_CHILDREN_SPARE_MAX: 3
    volumes:
      - app:/app

volumes:
  app:
