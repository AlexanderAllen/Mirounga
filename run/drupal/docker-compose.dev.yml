version: '3.7'

# Dev stack
#
# - Drupal source code does not change with the environment.
# - Uses PHP FPM image with debugging tools enabled.
# - MUST use MOUNTED volumes instead of NAMED volumes in order to view and debug sources from host IDEs.
# - However with VSC it may be possible to avoid mounts https://code.visualstudio.com/docs/remote/containers-advanced

services:

  # drupal:
  #   # The codebase is environment-agnostic and therefore hardcoded to prod.
  #   image: "alexanderallen/drupal-8.prod:alpine-3.11"
  #   volumes:
  #     - app:/app

  # Automatically install or update local source on launch for development.
  drush:
    image: alexanderallen/php7-cli-drush9.dev:alpine-3.11
    environment:
      INSTALL_DRUPAL: 1
    working_dir: /app
    volumes:
      - ./app:/app

  nginx:
    volumes:
      - ./app:/app

  php-fpm:
    # Allow nobody user logging to /dev/stdout.
    tty: true
    image: "alexanderallen/php7-fpm.${ENVIRONMENT:-dev}:alpine-3.11"
    environment:
      PHP_FPM_SLOWLOG_TIMEOUT: 0
      # Use environment variables to speed up FPM optimization cycles.
      PHP_FPM_PM_MANAGER: dynamic
      PHP_FPM_CHILDREN_MAX: 15
      # Default Value: min_spare_servers + (max_spare_servers - min_spare_servers) / 2
      PHP_FPM_CHILDREN_START: 7
      PHP_FPM_CHILDREN_SPARE_MIN: 5
      PHP_FPM_CHILDREN_SPARE_MAX: 10

      # - /c/Users/richa/Sites:/www
      # - ~/Sites/xhprof_run:/var/tmp/xhprof

      # See these issues:
      # * https://github.com/docker/for-linux/issues/264#issuecomment-564047473
      # XDEBUG_REMOTE_HOST: 10.254.254.254 # Docker for Mac host alias: use it instead of the default gateway 172.18.0.1.
      XDEBUG_REMOTE_HOST: host.docker.internal

      # Must be disabled (set to 0) in order for remote_host to work.
      # https://stackoverflow.com/a/55856941/467453
      # Recommended: DISABLE ON DOCKER
      # When enabled on Docker, XDebug connects to the Docker VM instead of the IDE client.
      XDEBUG_CONNECT_BACK: 0

      # Forward XDebug connection logs to Docker for debugging
      XDEBUG_REMOTE_LOG: /dev/stdout

      XDEBUG_REMOTE_PORT: 9000
      XDEBUG_IDE_KEY: 'PHPSTORM'
      XDEBUG_REMOTE_ENABLE: 1

      # If this setting is 1, then stacktraces will be shown by default on an error event.
      # It will also make xdebug logs extremely noisey and print caught exceptions as well.
      XDEBUG_DEFAULT_ENABLE: 0

      # If this setting is set to 1 then errors will always be displayed, no matter what the setting of PHP's
      # ; display_errors is.
      XDEBUG_FORCE_DISPLAY_ERRORS: 1

      # ; When this setting is set to 1, Xdebug will show a stack trace whenever an exception is raised - even if this exception
      # ; is actually caught.
      XDEBUG_SHOW_EXCEPTION_TRACE: 0

    volumes:
      - ./app:/app

volumes:
  app:
