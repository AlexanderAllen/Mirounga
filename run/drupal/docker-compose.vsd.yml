version: '3.7'
networks:
  default:
    external: true
    name: ${COMPOSE_NETWORK:-localenv}


# Dev stack
#
# - Drupal source code does not change with the environment.
# - Uses PHP FPM image with debugging tools enabled.
# - MUST use MOUNTED volumes instead of NAMED volumes in order to view and debug sources from host IDEs.
# - However with VSC it may be possible to avoid mounts https://code.visualstudio.com/docs/remote/containers-advanced

services:

  varnish:
    image: alexanderallen/varnish-6:alpine-3.12
    # Expose port 80 on the Varnish container, randomized on host.
    ports:
      - 80
    # Tell Varnish to listen on port 80 inside the container.
    # The backend is port 8080 of the nginx service.
    command: -F -s malloc,32M -a :80 -b nginx:8080
    # Start Varnish only after nginx has started.
    depends_on:
      - nginx

  nginx:
    image: alexanderallen/nginx:1.17-alpine
    tty: true
    ports:
      - 8080
    environment:
      # PROJECT_DEST: "${PROJECT_DEST}"
      PROJECT_DEST: "/vsdroot"
    volumes:

      # Main config.
      # - ./build/nginx/etc/nginx/nginx.conf:/etc/nginx/nginx.conf
      # Virtual host.
      # - ../../build/nginx/etc/nginx/conf.d/vhost.conf:/etc/nginx/conf.d/default.conf
      # NJS script.
      # - ./build/nginx/etc/nginx/http.js:/etc/nginx/http.js

      # PHP-FPM socket.
      - drawer:/sock

      # Project source.
      - "${PROJECT_SOURCE}:/vsdroot"

  # Per-project php-fpm container.
  # Each project gets it's own socket with visibiilty into the project's files.
  php-fpm:

    volumes:
      - "${PROJECT_SOURCE}:/vsdroot"
      - drawer:/sock

    # Allow nobody user logging to /dev/stdout.
    tty: true

    # The prod image is not setup for xdebug, use the dev image.
    image: "alexanderallen/php7-fpm.dev:alpine-3.11"
    environment:
      # Currently ignored, hardcoded in
      # build\php-fpm\php-fpm.d\docker-pool.conf
      PHP_FPM_LISTEN: /sock/docker.sock

      PHP_INI_MAX_EXECUTION_TIME: 0 # Set to 0 for unlimited.
      PHP_INI_MEM_LIMIT: 256M # The default memory limit is 128M.
      # PHP_FPM_LISTEN: 127.0.0.1:9010 # The default port is 9000, which conflicts with XDebug. Move to 9010.
      PHP_FPM_WORKER_LOGOUTPUT: 1

      PHP_FPM_SLOWLOG_TIMEOUT: 0
      # Use environment variables to speed up FPM optimization cycles.
      PHP_FPM_PM_MANAGER: dynamic
      PHP_FPM_CHILDREN_MAX: 15
      # Default Value: min_spare_servers + (max_spare_servers - min_spare_servers) / 2
      PHP_FPM_CHILDREN_START: 7
      PHP_FPM_CHILDREN_SPARE_MIN: 5
      PHP_FPM_CHILDREN_SPARE_MAX: 10

      # Location of the Windows Subsystem for Linux Host.
      XDEBUG_REMOTE_HOST: ${XDEBUG_REMOTE_HOST}

      # Must be disabled (set to 0) in order for remote_host to work.
      # https://stackoverflow.com/a/55856941/467453
      # Recommended: DISABLE ON DOCKER
      # When enabled on Docker, XDebug connects to the Docker VM instead of the IDE client.
      XDEBUG_CONNECT_BACK: 0

      # Forward XDebug connection logs to Docker for debugging
      XDEBUG_REMOTE_LOG: /dev/stdout

      XDEBUG_REMOTE_PORT: 9000
      XDEBUG_IDE_KEY: 'PHPSTORM'

      # ; This switch controls whether Xdebug should try to contact a debug client which is listening on the host and port as
      # ; set with the settings xdebug.remote_host and xdebug.remote_port
      XDEBUG_REMOTE_ENABLE: 1

      # If this setting is 1, then stacktraces will be shown by default on an error event.
      # It will also make xdebug logs extremely noisey and print caught exceptions as well.
      XDEBUG_DEFAULT_ENABLE: 0

      # If this setting is set to 1 then errors will always be displayed, no matter what the setting of PHP's
      # ; display_errors is.
      XDEBUG_FORCE_DISPLAY_ERRORS: 1

      # ; When this setting is set to 1, Xdebug will show a stack trace whenever an exception is raised - even if this exception
      # ; is actually caught.
      XDEBUG_SHOW_EXCEPTION_TRACE: 0


volumes:
  drawer:
