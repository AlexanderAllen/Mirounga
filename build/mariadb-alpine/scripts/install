#!/bin/sh

# Script to install / initialize MySQL during Docker build.
# MySQL install requires Perl.
# Remove Perl after running this script from system to reduce image size.

set -eox pipefail

echo ""
echo "RUNNING INSTALL SCRIPT"
echo ""

# This needs to be run both for initialization and general startup
# sed into /tmp/ since the user won't have access to create new
# files in /etc/
cp /tmp/my.cnf /etc/my.cnf.d/
[[ -n "${SKIP_INNODB}" ]] || [[ -f "/var/lib/mysql/noinnodb" ]] &&
  sed -i -e '/\[mariadb\]/a skip_innodb = yes\ndefault_storage_engine = MyISAM\ndefault_tmp_storage_engine = MyISAM' \
      -e '/^innodb/d' /etc/my.cnf.d/my.cnf
[[ -n "${SKIP_INNODB}" ]] && touch /var/lib/mysql/noinnodb



# Set root explicit root password if specified, otherwise set to blank.
ROOTPW="''"
[[ -n "${MYSQL_ROOT_PASSWORD}" ]] && ROOTPW="PASSWORD('${MYSQL_ROOT_PASSWORD}')"
# ERROR: 1471  The target table user of the INSERT is not insertable-into
# echo "INSERT INTO user VALUES ('%','root',${ROOTPW},'Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','Y','','','','',0,0,0,0,'','','N', 'N','', 0);" > /usr/share/mariadb/mysql_system_tables_data.sql

# https://mariadb.com/kb/en/mysql_install_db/#options
# You must be ROOT to use the "--user=" option
# The --user flag indicates what user the mysqld deamon will run under.
INSTALL_OPTS="--user=${CONTAINER_USER}"
INSTALL_OPTS="${INSTALL_OPTS} --cross-bootstrap"
INSTALL_OPTS="${INSTALL_OPTS} --rpm"
# https://github.com/MariaDB/server/commit/b9f3f068
# https://mariadb.com/kb/en/mysql_install_db/#user-accounts-created-by-default
INSTALL_OPTS="${INSTALL_OPTS} --auth-root-authentication-method=normal"
INSTALL_OPTS="${INSTALL_OPTS} --skip-test-db"
INSTALL_OPTS="${INSTALL_OPTS} --datadir=/var/lib/mysql"
/usr/bin/mysql_install_db ${INSTALL_OPTS} --verbose




# Initialize admin user.
# MariaDB> SET PASSWORD = PASSWORD('XH4VmT3_jt');
# mysql -e "select * from schema.table"
# echo "Setting root password ..."
# mysql -u root -e "SET PASSWORD = ''"
