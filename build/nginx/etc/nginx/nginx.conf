# FROM nginx:1.17-alpine
# /etc/nginx cat nginx.conf

# Running as user nobody or non-root user.
# user  nginx;

# https://nginx.org/en/docs/http/ngx_http_js_module.html
# load_module modules/ngx_http_js_module.so;
load_module /usr/lib/nginx/modules/ngx_http_js_module.so;



# Performance directives, not allowed in vhosts.
# The default number of workser is 1, we can do more.
# http://nginx.org/en/docs/ngx_core_module.html#worker_processes

# worker_processes  auto;
worker_processes 3;

# Set worker connection to worker connections * 2, shuould be not greater than systems ulimit -Sn (soft).
# worker_connections 1024;



# https://nginx.org/en/docs/ngx_core_module.html#error_log
error_log  stderr info;
pid        /var/run/nginx/nginx.pid;

# Declare where the mounted docroot is at.
# Env var is fed by docker compose.
# Expecting       PROJECT_DEST: "/vsdroot"
env PROJECT_DEST;

events {
    worker_connections  1024;
}

http {
    js_import /etc/nginx/http.js;
    js_set $foo http.foo;

    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Define default log format.
    log_format  main  'Main log: $remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    # Define log format for PHP-FPM requests.
    log_format docker '
Docker log:
Remote Addr: $remote_addr
Request: "$request"
Status: $status
document_root: $document_root
fastcgi_script_name: $fastcgi_script_name
<domaincapture>: $domaincapture
uri: $uri
';

    # Specify default log format to use.
    access_log  /dev/stdout main;

    sendfile        on;
    keepalive_timeout  65;

    # Virtual host configuration.
    include /etc/nginx/conf.d/*.conf;
}
